#!/bin/bash
set -evu

# 1. Install necessary build tools
python -m pip install --upgrade pip wheel build

# 2. Build your package wheel
python -m build

# 3. Install the complete development and testing environment in one step.
#    This command installs main, test, and dev dependencies.
python -m pip install .[dev]

# 4. Re-install using the wheel file to ensure you're testing the final artifact.
#    The --force-reinstall flag ensures the wheel overwrites the editable install.
python -m pip install --force-reinstall dist/*.whl

# 5. Run the tests from the root directory
pytest tests/

# 6. Conditionally run your mypy check
if [[ "${MYPY}" = "mypy" ]]; then
    echo "--- Running mypy check ---"
    ${GITHUB_WORKSPACE}/mypy-check ${GITHUB_WORKSPACE}
fi