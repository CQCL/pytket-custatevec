name: Test (Py3.12, minimal)

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Ensure python3.12 exists
        shell: bash
        run: |
          command -v python3.12 >/dev/null || { echo "python3.12 not found"; exit 1; }
          python3.12 -V

      - name: Create env (prefer venv, fallback to virtualenv)
        shell: bash
        run: |
          set -euo pipefail
          if python3.12 -m venv .venv --system-site-packages 2>/dev/null; then
            echo "Created venv with built-in venv"
          else
            echo "Built-in venv unavailable; using virtualenv fallback"
            # install virtualenv just for this user; avoids needing root
            python3.12 -m pip install --user virtualenv
            python3.12 -m virtualenv .venv --system-site-packages
          fi

          # activate and run tests
          source .venv/bin/activate
          python -m pip install -U pip setuptools wheel
          python -m pip install --no-build-isolation ".[test]"
          pytest -q
